#! /usr/bin/env python
import copy
import sys

from chimera.core.cli import ChimeraCLI, action
from chimera.core.compat import freeze_support
from chimera.interfaces.pointverify import CantSetScopeException


class ChimeraAutoSkyFlat(ChimeraCLI):
    def __init__(self):
        ChimeraCLI.__init__(self, "chimera-skyflat", "SkyFlats", 0.1)
        self.addHelpGroup("SKYFLAT", "skyFlats")
        self.addController(name="skyflat",
                           cls="AutoSkyFlat",
                           required=True,
                           helpGroup="SKYFLAT",
                           help="Auto Sky Flats")
        self.addParameters(
            dict(name="sun_alt_hi",
                 long="sunHi",
                 type="float",
                 helpGroup="SKYFLAT",
                 help="Highest Sun altitude",
                 metavar="FILE"),
            dict(name="sun_alt_low",
                 long="sunLow",
                 type="float",
                 helpGroup="SKYFLAT",
                 help="Lowest Sun altitude",
                 metavar="FILE"))

    @action(long="auto",
            help="Does a sequence of sky flats",
            helpGroup="SKYFLAT")
    def doSequence(self, options):
        """
        Sets variables using command line options
        Take skyflats according to options
        """
        self.out("Pointing scope to the zenith and waiting for the Sun to reach skyflats altitude range")
        if options.sun_alt_low > options.sun_alt_hi:
            self.exit("sunHi needs to be less than sunLow")
        if options.sun_alt_hi:
            self.skyflat["sun_alt_hi"] = options.sun_alt_hi
        if options.sun_alt_low:
            self.skyflat["sun_alt_low"] = options.sun_alt_low
        try:
            self.skyflat.getFlats()
        # what is this e for ???
        except CantSetScopeException:
            self.exit("Can't set scope")
        self.out("OK")

    def __abort__(self):
        self.out("\naborting... ", endl="")

        # copy self.skyflat Proxy because we are running from a differente
        # thread (yes, Pyro is tricky!)
        skyflat = copy.copy(self.skyflat)
        skyflat.abort()


def main():
    cli = ChimeraAutoSkyFlat()
    cli.run(sys.argv)
    cli.wait()


if __name__ == '__main__':
    freeze_support()
    main()
